<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kelp Forest Viewer (Optimized)</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }
    #controls {
      position: absolute; top: 20px; left: 20px;
      background: rgba(0,40,80,0.9); padding: 20px;
      border-radius: 10px; color: white; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2); min-width: 220px; z-index:100;
    }
    .control-group { margin-bottom: 15px; }
    .control-group:last-child { margin-bottom:0; }
    .control-group label {
      display: block; font-size:13px; margin-bottom:8px; color:#a8d0f0; font-weight:500;
    }
    .control-group input[type="range"] {
      width:100%; height:6px; background:rgba(255,255,255,0.2);
      border-radius:3px; outline:none; -webkit-appearance:none;
    }
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance:none; width:16px; height:16px;
      background:#00d4ff; border-radius:50%; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,212,255,0.4);
    }
    .control-group input[type="range"]::-moz-range-thumb {
      width:16px; height:16px; background:#00d4ff; border-radius:50%;
      cursor:pointer; border:none; box-shadow:0 2px 6px rgba(0,212,255,0.4);
    }
    .value { color:#00d4ff; font-weight:bold; font-size:14px; }
    #info {
      position:absolute; bottom:20px; left:20px; color:rgba(255,255,255,0.8);
      font-size:12px; background:rgba(0,40,80,0.7); padding:10px 15px;
      border-radius:8px; backdrop-filter:blur(5px); line-height:1.4;
    }
    #loading {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      color:white; text-align:center; font-size:18px; z-index:200;
      background:rgba(0,40,80,0.8); padding:20px; border-radius:10px;
    }
  </style>
</head>
<body>
  <div id="loading">Loading Kelp Forest...</div>
  <div id="controls">
    <div class="control-group">
      <label>Ocean Movement: <span class="value" id="oceanVal">1.0</span></label>
      <input type="range" id="oceanMovement" min="0" max="3" step="0.1" value="1.0">
    </div>
    <div class="control-group">
      <label>Wave Strength: <span class="value" id="waveVal">1.0</span></label>
      <input type="range" id="waveStrength" min="0" max="2" step="0.1" value="1.0">
    </div>
    <div class="control-group">
      <label>Current Direction: <span class="value" id="dirVal">0</span>°</label>
      <input type="range" id="currentDirection" min="0" max="360" step="15" value="0">
    </div>
    <div class="control-group">
      <label>Camera Speed: <span class="value" id="speedVal">1.0</span></label>
      <input type="range" id="cameraSpeed" min="0.1" max="3" step="0.1" value="1.0">
    </div>
    <div class="control-group">
      <label>Forest Density: <span class="value" id="densityVal">15</span></label>
      <input type="range" id="forestDensity" min="5" max="30" step="5" value="15">
    </div>
  </div>
  <div id="info">
    <strong>Kelp Forest Explorer</strong><br>
    Left drag: Rotate • Right drag: Pan • Scroll: Zoom<br>
    <span id="statusText">Loading model...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // constants
    const MODEL_SCALE = 1; // shrink entire model
    let forestDensity = 15;

    // basic scene/camera/renderer
    const scene = new THREE.Scene();
    // underwater gradient background
    const bg = document.createElement('canvas');
    bg.width = bg.height = 512;
    const ctx = bg.getContext('2d');
    const grad = ctx.createLinearGradient(0,0,0,512);
    grad.addColorStop(0,'#87CEEB');
    grad.addColorStop(0.3,'#4682B4');
    grad.addColorStop(0.7,'#2F4F4F');
    grad.addColorStop(1,'#1B3A4B');
    ctx.fillStyle = grad; ctx.fillRect(0,0,512,512);
    scene.background = new THREE.CanvasTexture(bg);

    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 200);
    camera.position.set(0,8,20);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    // controls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor = 0.05;
    controls.minDistance = 3; controls.maxDistance = 50;
    controls.target.set(0,5,0);

    // lights
    scene.add(new THREE.AmbientLight(0x87CEEB, 0.4));
    const sun = new THREE.DirectionalLight(0xB0E0E6, 1.2);
    sun.position.set(20,50,10); sun.castShadow = true;
    scene.add(sun);

    // ocean floor (PlaneGeometry in XZ, displace Y!)
    const floorGeo = new THREE.PlaneGeometry(500, 500);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x8B7355 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2; // Rotate to lie flat (XZ plane)
    floor.position.y = 0;
    floor.receiveShadow = true;
    scene.add(floor);


    // control vars & UI hookup
    let oceanMovement = 1, waveStrength = 1, currentDir=0, cameraSpeed=1;
    function $(id){return document.getElementById(id);}
    function bind(id, cb){
      $(id).addEventListener('input', e=>{
        cb(parseFloat(e.target.value));
        e.target.nextElementSibling && (e.target.nextElementSibling.textContent = e.target.value);
      });
    }
    bind('oceanMovement', v=> oceanMovement=v); 
    bind('waveStrength', v=> waveStrength=v);
    bind('currentDirection', v=> currentDir=v);
    bind('cameraSpeed', v=> { cameraSpeed=v; controls.autoRotateSpeed=v*2; });
    bind('forestDensity', v=>{
      forestDensity = Math.round(v);
      $('densityVal').textContent = forestDensity;
      resetForest();
    });

    // load & clone model
    const loader = new THREE.GLTFLoader();
    loader.load(
      'https://raw.githubusercontent.com/VividAidsCTC/boonetest/99e8af7024a27e85ca31e3bedec37c7c8204101a/animated_kelp.glb',
      gltf => {
        const root = gltf.scene;
        root.scale.setScalar(MODEL_SCALE);
        scene.add(root); // optional single model
        $('loading').style.display='none';
        $('statusText').textContent = 'Creating forest…';
        original = root;
        resetForest();
        $('statusText').textContent = 'Ready!';
      },
      prog => {
        const p = prog.total ? (prog.loaded/prog.total*100).toFixed(1)+'%' : '';
        $('statusText').textContent = `Loading: ${p}`;
      },
      err => { console.error(err); $('statusText').textContent='Load error'; }
    );

    let original, kelps=[], mixers=[], clock=new THREE.Clock(), t=0;
    function resetForest(){
      // clear old
      kelps.forEach(m=>scene.remove(m));
      kelps=[]; mixers=[];
      if(!original) return;
      for(let i=0; i<forestDensity; i++){
        const clone = original.clone();
        clone.position.set(
          (Math.random()-0.5)*30,
          0,
          (Math.random()-0.5)*30
        );
        clone.rotation.y = Math.random()*Math.PI*2;
        const s = 0.8 + Math.random()*0.4;
        clone.scale.setScalar(MODEL_SCALE * s);
        scene.add(clone);
        kelps.push(clone);
      }
    }

    // animate
    function animate(){
      requestAnimationFrame(animate);
      const dt = clock.getDelta();
      t += dt*oceanMovement;
      controls.update();
      kelps.forEach((k,i)=>{
        // simple sway
        const phase = i*0.5;
        const sway = Math.sin(t+phase)*0.2 + Math.cos((t+phase)*0.7)*0.1;
        k.position.x += sway * Math.cos(currentDir*Math.PI/180) * waveStrength;
        k.position.z += sway * Math.sin(currentDir*Math.PI/180) * waveStrength;
      });
      renderer.render(scene,camera);
    }
    animate();

    // resize
    window.addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });
  </script>
</body>
</html>
